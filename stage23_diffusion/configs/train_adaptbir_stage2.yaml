# Path to your experiment directory.
expdir: diffusion/expdir_stage2

model:
  auto_resume: False
  # Path to your model config.
  config: diffusion/configs/model_stage2.yaml
  # Path to the weights you want to resume. At the begining, this should 
  # be set to the initial weights generated by scripts/tool_add_control_sd21.py.
  resume: diffusion/tests/train/sd_codeformer_init.ckpt

train:
  # Indices of gpus used for training.
  gpus: [0,1,2,3]
  seed: 231
  batch_size: 26
  # Log images every [logger_freq] steps.
  logger_freq: 300
  prefetch_factor: 2
  learning_rate: 1e-4
  sd_locked: True
  only_mid_control: False
  # Save weight every [save_every_n_steps] steps.
  save_every_n_steps: 1500
  max_steps: 70001 # 70k

data:
  target: cldm.dataset.realesrgan_dataset.RealESRGANDataset
  params:
    opt:
      meta_info: # Path to training set info.
      queue_size: 180
      use_crop: true
      crop_type: random_crop
      
      blur_kernel_size: 21
      kernel_list: ['iso', 'aniso', 'generalized_iso', 'generalized_aniso', 'plateau_iso', 'plateau_aniso']
      kernel_prob: [0.45, 0.25, 0.12, 0.03, 0.12, 0.03]
      sinc_prob: 0.1
      blur_sigma: [0.2, 3]
      betag_range: [0.5, 4]
      betap_range: [1, 2]

      blur_kernel_size2: 21
      kernel_list2: ['iso', 'aniso', 'generalized_iso', 'generalized_aniso', 'plateau_iso', 'plateau_aniso']
      kernel_prob2: [0.45, 0.25, 0.12, 0.03, 0.12, 0.03]
      sinc_prob2: 0.1
      blur_sigma2: [0.2, 1.5]
      betag_range2: [0.5, 4]
      betap_range2: [1, 2]

      final_sinc_prob: 0.8

      # the first degradation process
      resize_prob: [0.2, 0.7, 0.1]  # up, down, keep
      resize_range: [0.15, 1.5]
      gaussian_noise_prob: 0.5
      noise_range: [1, 30]
      poisson_scale_range: [0.05, 3]
      gray_noise_prob: 0.4
      jpeg_range: [30, 95]
      
      # the second degradation process
      scale: 4
      second_blur_prob: 0.8
      resize_prob2: [0.3, 0.4, 0.3]  # up, down, keep
      resize_range2: [0.3, 1.2]
      gaussian_noise_prob2: 0.5
      noise_range2: [1, 25]
      poisson_scale_range2: [0.05, 2.5]
      gray_noise_prob2: 0.4
      jpeg_range2: [30, 95]

      out_size: 512
      use_hflip: False
      use_rot: False

  num_workers: 4

lightning:
  trainer:
    benchmark: True
    max_steps: 800000
    accumulate_grad_batches: 4
